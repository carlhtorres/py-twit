version: "3.5"

services:
  py-twit:
    hostname: py-twit
    image: py-twit
    build:
      context: ./application
      dockerfile: Dockerfile
    environment:
      - "API_KEY=${API_KEY}"
      - "API_KEY_SECRET=${API_KEY_SECRET}"
      - "ACCESS_TOKEN_KEY=${ACCESS_TOKEN_KEY}"
      - "ACCESS_TOKEN_SECRET=${ACCESS_TOKEN_SECRET}"
    ports:
      - "8000:8000"

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:6.2.4
    environment:
      - discovery.type=single-node
      - ELASTIC_PASSWORD_FILE=/run/secrets/password.txt
    labels:
      - co.elastic.logs/fileset.stdout=access
      - co.elastic.logs/fileset.stderr=error

  filebeat:
    hostname: filebeat
    image: filebeat:local
    build:
      context: ./logging
      dockerfile: Dockerfile-filebeat
    volumes:
      - "/var/lib/docker/containers:/usr/share/filebeat/dockerlogs:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
    links:
      - elasticsearch
      - kibana

  kibana:
    image: docker.elastic.co/kibana/kibana:6.2.4
    ports:
      - "5601:5601"
    links:
      - elasticsearch

  prometheus:
    image: prometheus
    build:
      context: ./metrics
      dockerfile: Dockerfile-prometheus
    links:
      - kibana
      - py-twit

